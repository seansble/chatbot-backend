# backend/test_complex_queries.py
import os
import sys

sys.path.append(".")
os.environ["USE_REAL_EMBEDDING"] = "true"

from rag.vectorstore import QdrantVectorStore
from rag.embedder import BGEEmbedder

# ì´ˆê¸°í™”
print("ğŸ”§ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...")
embedder = BGEEmbedder()
vector_store = QdrantVectorStore()

# ë³µì¡í•œ í…ŒìŠ¤íŠ¸ ì§ˆë¬¸ë“¤
complex_queries = [
    # 1. ë³µí•© ì¡°ê±´
    "ì£¼3ì¼ ì•Œë°” 8ê°œì›” í–ˆëŠ”ë° ì¼ìˆ˜ëŠ” 180ì¼ ë„˜ëŠ”ë° ì‹œê°„ì´ ë¶€ì¡±í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?",
    # 2. ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜
    "ìƒì‚¬ê°€ ë§¤ì¼ ìš•í•˜ê³  ë•Œë ¤ì„œ ë³‘ì› ì§„ë‹¨ì„œ ë°›ê³  ë…¹ìŒë„ í–ˆëŠ”ë° íšŒì‚¬ëŠ” ìì§„í‡´ì‚¬ ì²˜ë¦¬í•˜ë ¤ê³  í•´ìš”",
    # 3. ìˆœì°¨ì  ìƒí™©
    "ìœ¡ì•„íœ´ì§ 1ë…„ ì“°ê³  ë³µì§í–ˆë‹¤ê°€ 2ê°œì›” ë’¤ì— ë˜ ì„ì‹ í•´ì„œ ì¶œì‚°íœ´ê°€ ì“°ê³  ì‹¶ì€ë° ì‹¤ì—…ê¸‰ì—¬ëŠ”?",
    # 4. ì˜ˆì™¸ ì¼€ì´ìŠ¤
    "í”„ë¦¬ëœì„œë¡œ 3ë…„ ì¼í•˜ë‹¤ê°€ ì •ê·œì§ ì „í™˜ í›„ 4ê°œì›”ë§Œì— íšŒì‚¬ ë§í–ˆì–´ìš”",
    # 5. ë³µìˆ˜ ì¡°ê±´ ì¶©ì¡±
    "65ì„¸ ë„˜ì—ˆëŠ”ë° ì¥ì• ì¸ì´ê³  ìµœì €ì„ê¸ˆ ë°›ìœ¼ë©° ê³„ì•½ì§ì¸ë° ì‹¤ì—…ê¸‰ì—¬ ì–¼ë§ˆë‚˜ ë°›ì„ ìˆ˜ ìˆë‚˜?",
    # 6. ëª¨í˜¸í•œ ì§ˆë¬¸
    "ì €ë²ˆë‹¬ì— ê·¸ë§Œë’€ëŠ”ë° ì§€ê¸ˆ ì‹ ì²­í•˜ë©´ ëŠ¦ë‚˜ìš”? ë²Œì¨ í•œë‹¬ ì§€ë‚¬ëŠ”ë°...",
    # 7. ê³„ì‚° í•„ìš”
    "ì›” 350ë§Œì› ë°›ë‹¤ê°€ í‡´ì‚¬í–ˆëŠ”ë° ì•¼ê·¼ìˆ˜ë‹¹ ë¹¼ë©´ ê¸°ë³¸ê¸‰ 250ì¸ë° ì‹¤ì—…ê¸‰ì—¬ëŠ” ë­˜ë¡œ ê³„ì‚°?",
    # 8. ì¤‘ë³µ ìƒí™©
    "ê¶Œê³ ì‚¬ì§ í•˜ë©´ì„œ íšŒì‚¬ê°€ ìì§„í‡´ì‚¬ë¡œ ì¨ë‹¬ë˜ìš”. ë…¹ìŒì€ ìˆëŠ”ë° ë¬¸ì„œëŠ” ì—†ì–´ìš”",
    # 9. íŠ¹ìˆ˜ ì§ì¢…
    "ë°°ë¯¼ ë¼ì´ë” 2ë…„í–ˆê³  ì¿ íŒ¡í”Œë ‰ìŠ¤ë„ ê°™ì´í–ˆëŠ”ë° ë‘˜ ë‹¤ ê·¸ë§Œë‘ë©´ ì‹¤ì—…ê¸‰ì—¬ ë˜ë‚˜ìš”?",
    # 10. í˜¼í•© ì§ˆë¬¸
    "2025ë…„ 1ì›”ì— 4ë²ˆì§¸ ì‹¤ì—…ê¸‰ì—¬ì¸ë° ë‚˜ì´ 60ì‚´ì´ê³  ì¥ì• ì¸ì´ë©´ ê°ì•¡ ì•ˆë˜ë‚˜ìš”?",
]

print("\n" + "=" * 70)
print("ë³µì¡ë„ ë†’ì€ RAG í…ŒìŠ¤íŠ¸")
print("=" * 70)

for i, query in enumerate(complex_queries, 1):
    print(f"\n[ì§ˆë¬¸ {i}] {query}")
    print("-" * 70)

    # í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰
    query_embedding = embedder.embed_query(query)
    results = vector_store.hybrid_search(query, query_embedding, top_k=5)

    print(f"ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½:")
    for j, result in enumerate(results[:3], 1):
        print(f"  {j}. Score: {result.get('hybrid_score', 0):.3f}")
        print(
            f"     BM25: {result.get('bm25_rrf', 0):.3f}, Vector: {result.get('vector_rrf', 0):.3f}"
        )
        print(f"     ë‚´ìš©: {result['text'][:60]}...")

    # ìƒìœ„ 1ìœ„ì™€ 5ìœ„ì˜ ì ìˆ˜ ì°¨ì´ ë¶„ì„
    if len(results) >= 5:
        score_gap = results[0]["hybrid_score"] - results[4]["hybrid_score"]
        print(f"\n  ğŸ“Š 1ìœ„-5ìœ„ ì ìˆ˜ ì°¨: {score_gap:.3f}")
        if score_gap < 0.05:
            print(f"  âš ï¸ ì ìˆ˜ ì°¨ì´ ì‘ìŒ - ë¶ˆí™•ì‹¤í•œ ê²€ìƒ‰ ê²°ê³¼")
        elif score_gap > 0.1:
            print(f"  âœ… ëª…í™•í•œ ê´€ë ¨ ë¬¸ì„œ ì°¾ìŒ")

print("\n" + "=" * 70)
print("âœ… ë³µì¡ë„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
