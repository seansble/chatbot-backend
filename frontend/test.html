<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì—…ê¸‰ì—¬ ì±—ë´‡ í…ŒìŠ¤íŠ¸ - Qwen3</title>
    <style>
        body { 
            font-family: 'Noto Sans KR', Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        /* ë””ë²„ê·¸ íŒ¨ë„ */
        .debug-panel {
            background-color: #f0f0f0;
            border: 2px dashed #999;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .debug-panel h3 {
            margin-top: 0;
            color: #666;
        }
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: white;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .debug-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .debug-btn {
            padding: 8px 15px;
            font-size: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .debug-btn:hover {
            background: #1976D2;
        }
        .debug-btn.danger {
            background: #f44336;
        }
        .debug-btn.danger:hover {
            background: #d32f2f;
        }
        .debug-btn.success {
            background: #4CAF50;
        }
        .mode-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }
        .mode-dev {
            background: #ffeb3b;
            color: #333;
        }
        .mode-prod {
            background: #4CAF50;
            color: white;
        }
        
        .model-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .info-bar {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remaining-count {
            font-weight: bold;
            color: #2e7d32;
        }
        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        #question {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        #question:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .char-count {
            position: absolute;
            right: 10px;
            bottom: -20px;
            font-size: 12px;
            color: #666;
        }
        .char-count.warning {
            color: #ff9800;
        }
        .char-count.error {
            color: #f44336;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #response { 
            margin-top: 20px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
            min-height: 100px;
            background-color: #fafafa;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        /* êµ¬ì¡°í™”ëœ ë‹µë³€ ìŠ¤íƒ€ì¼ */
        #response .result-box {
            background: #e3f2fd;
            padding: 10px;
            border-left: 4px solid #2196F3;
            margin-bottom: 10px;
        }
        #response .basis-box {
            background: #f3e5f5;
            padding: 10px;
            border-left: 4px solid #9c27b0;
            margin-bottom: 10px;
        }
        #response .detail-box {
            background: #fff3e0;
            padding: 10px;
            border-left: 4px solid #ff9800;
            margin-bottom: 10px;
        }
        #response .docs-box {
            background: #e8f5e9;
            padding: 10px;
            border-left: 4px solid #4caf50;
            margin-bottom: 10px;
        }
        
        .loading {
            color: #4CAF50;
            font-style: italic;
        }
        .error {
            color: #f44336;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .toggle-debug {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 1000;
        }
        
        .sample-questions {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .sample-btn {
            display: inline-block;
            margin: 3px;
            padding: 5px 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .sample-btn:hover {
            background: #d0d0d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì‹¤ì—…ê¸‰ì—¬ ì±—ë´‡ í…ŒìŠ¤íŠ¸ 
            <span class="mode-indicator" id="modeIndicator">ê°œë°œ ëª¨ë“œ</span>
            <span class="model-badge">Qwen3-235B</span>
        </h1>
        
        <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
        <div class="debug-panel" id="debugPanel">
            <h3>ğŸ”§ ë””ë²„ê¹… íŒ¨ë„ (Qwen3 ëª¨ë¸)</h3>
            
            <div class="debug-info">
                <strong>í˜„ì¬ ìƒíƒœ:</strong><br>
                ëª¨ë¸: Qwen3-235B-A22B-Instruct-2507<br>
                API: OpenRouter<br>
                ì§€ë¬¸(Fingerprint): <span id="fpDisplay">-</span><br>
                ê³„ì‚°ê¸° ì‚¬ìš©: <span id="calcStatus">âŒ</span><br>
                ê³„ì‚° ë°ì´í„°: <span id="calcDataStatus">ì—†ìŒ</span><br>
                ì˜¤ëŠ˜ ì‚¬ìš©: <span id="usageCount">0</span>íšŒ<br>
                ì¿ í‚¤: <span id="cookieStatus">ì—†ìŒ</span><br>
                ëª¨ë“œ: <span id="currentMode">-</span>
            </div>
            
            <div class="debug-buttons">
                <button class="debug-btn success" onclick="simulateCalculator()">ê³„ì‚°ê¸° ì‚¬ìš© ì‹œë®¬ë ˆì´ì…˜</button>
                <button class="debug-btn success" onclick="addCalcData()">ê³„ì‚° ë°ì´í„° ì¶”ê°€</button>
                <button class="debug-btn" onclick="changeFingerprint()">ì§€ë¬¸ ë³€ê²½ (ìƒˆ ì‚¬ìš©ì)</button>
                <button class="debug-btn danger" onclick="clearAllData()">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
                <button class="debug-btn danger" onclick="clearCookies()">ì¿ í‚¤ ì´ˆê¸°í™”</button>
                <button class="debug-btn" onclick="toggleMode()">ëª¨ë“œ ì „í™˜</button>
                <button class="debug-btn" onclick="showStorageInfo()">Storage ì •ë³´ ë³´ê¸°</button>
            </div>
            
            <div class="debug-info" style="margin-top: 10px;">
                <strong>í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:</strong><br>
                1. "ê³„ì‚°ê¸° ë¯¸ì‚¬ìš©" í…ŒìŠ¤íŠ¸: ì´ˆê¸°í™” â†’ ì§ˆë¬¸ ì „ì†¡<br>
                2. "ê³„ì‚°ê¸° ì‚¬ìš©" í…ŒìŠ¤íŠ¸: ê³„ì‚°ê¸° ì‹œë®¬ë ˆì´ì…˜ â†’ ì§ˆë¬¸ ì „ì†¡<br>
                3. "3íšŒ ì œí•œ" í…ŒìŠ¤íŠ¸: ê³„ì‚°ê¸° ì‹œë®¬ë ˆì´ì…˜ â†’ 4ë²ˆ ì§ˆë¬¸<br>
                4. "ìƒˆ ì‚¬ìš©ì" í…ŒìŠ¤íŠ¸: ì§€ë¬¸ ë³€ê²½ â†’ ë‹¤ì‹œ ì‹œì‘<br>
                5. "ì¿ í‚¤ ìš°íšŒ" í…ŒìŠ¤íŠ¸: ì¿ í‚¤ ì‚­ì œ â†’ IP+ì§€ë¬¸ìœ¼ë¡œ ì—¬ì „íˆ ì°¨ë‹¨ í™•ì¸
            </div>
        </div>
        
        <div class="info-bar">
            <span>ğŸ’¡ ì‹¤ì—…ê¸‰ì—¬, êµ¬ì§ê¸‰ì—¬, ê³ ìš©ë³´í—˜ ê´€ë ¨ ì§ˆë¬¸ë§Œ ë‹µë³€ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
            <span class="remaining-count" id="remainingCount">ì˜¤ëŠ˜ ë‚¨ì€ ì§ˆë¬¸: 3íšŒ</span>
        </div>
        
        <div class="input-wrapper">
            <input 
                type="text" 
                id="question" 
                placeholder="ì‹¤ì—…ê¸‰ì—¬ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 150ì)" 
                maxlength="150"
            >
            <span class="char-count" id="charCount">0/150</span>
        </div>
        
        <button onclick="sendQuestion()" id="sendBtn">ì „ì†¡</button>
        
        <div class="sample-questions">
            <strong>ì˜ˆì‹œ ì§ˆë¬¸:</strong><br>
            <button class="sample-btn" onclick="setSampleQuestion('ê³„ì•½ì§ 3ë…„ ì¼í–ˆëŠ”ë° ê³„ì•½ë§Œë£Œëì–´ìš”. ì‹¤ì—…ê¸‰ì—¬ ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?')">ê³„ì•½ë§Œë£Œ</button>
            <button class="sample-btn" onclick="setSampleQuestion('ìœ¡ì•„íœ´ì§ ì¤‘ íšŒì‚¬ê°€ íì—…í–ˆëŠ”ë° ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')">ìœ¡ì•„íœ´ì§</button>
            <button class="sample-btn" onclick="setSampleQuestion('ì›”ê¸‰ 400ë§Œì›ì´ì—ˆëŠ”ë° ì–¼ë§ˆë‚˜ ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?')">ê¸‰ì—¬ ê³„ì‚°</button>
            <button class="sample-btn" onclick="setSampleQuestion('í¸ì˜ì  ì•Œë°”í•˜ë©´ì„œ ì •ê·œì§ ë‹¤ë‹ˆë‹¤ê°€ ì •ê·œì§ íšŒì‚¬ê°€ íì—…í–ˆì–´ìš”')">ì´ì¤‘ê·¼ë¬´</button>
            <button class="sample-btn" onclick="setSampleQuestion('52ì„¸ì¸ë° 5ë…„ ê·¼ë¬´í•˜ê³  ê¶Œê³ ì‚¬ì§ë‹¹í–ˆì–´ìš”')">50ì„¸ ì´ìƒ</button>
        </div>
        
        <div id="response"></div>
    </div>
    
    <!-- ë””ë²„ê·¸ í† ê¸€ ë²„íŠ¼ -->
    <div class="toggle-debug" onclick="toggleDebugPanel()">ğŸ› </div>

    <script>
        const questionInput = document.getElementById('question');
        const charCountSpan = document.getElementById('charCount');
        const sendBtn = document.getElementById('sendBtn');
        const responseDiv = document.getElementById('response');
        const remainingCountSpan = document.getElementById('remainingCount');
        
        let isDevMode = true; // ê°œë°œ ëª¨ë“œ í”Œë˜ê·¸
        let currentUsageCount = 0; // í˜„ì¬ ì‚¬ìš© íšŸìˆ˜
        
        // ë¸Œë¼ìš°ì € í•‘ê±°í”„ë¦°íŒ…
        function getFingerprint() {
            if (isDevMode) {
                return "DEV_FINGERPRINT"; // ê°œë°œ ëª¨ë“œì¼ ë•Œ
            }
            const fp = {
                s: screen.width + 'x' + screen.height,
                t: Intl.DateTimeFormat().resolvedOptions().timeZone,
                l: navigator.language,
                c: navigator.hardwareConcurrency || 2,
                p: navigator.platform,
                v: navigator.vendor
            };
            return btoa(JSON.stringify(fp));
        }
        
        // ì¿ í‚¤ ì²´í¬
        function checkCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                if (cookie.trim().startsWith('usage_token=')) {
                    return cookie.trim().substring(12);
                }
            }
            return null;
        }
        
        // ê³„ì‚°ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getCalculatorData() {
            const calcData = sessionStorage.getItem('calcData');
            return calcData ? JSON.parse(calcData) : null;
        }
        
        // ê³„ì‚°ê¸° ì‚¬ìš© ì²´í¬
        function checkCalculatorUsage() {
            const fingerprint = getFingerprint();
            const calcUsed = sessionStorage.getItem('calc_used_' + fingerprint);
            
            updateDebugInfo();
            return calcUsed ? true : false;
        }
        
        // ìƒ˜í”Œ ì§ˆë¬¸ ì„¤ì •
        function setSampleQuestion(question) {
            questionInput.value = question;
            const event = new Event('input');
            questionInput.dispatchEvent(event);
        }
        
        // ë””ë²„ê·¸ í•¨ìˆ˜ë“¤
        function simulateCalculator() {
            const fingerprint = getFingerprint();
            sessionStorage.setItem('calc_used_' + fingerprint, 'true');
            
            // ì„œë²„ì— ì•Œë¦¼ (ì¿ í‚¤ ì§€ì›)
            fetch('http://localhost:5000/api/mark-calculator-used', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fingerprint: fingerprint }),
                credentials: 'include'  // ì¿ í‚¤ í¬í•¨
            }).then(() => {
                alert('ê³„ì‚°ê¸° ì‚¬ìš© ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!');
                updateDebugInfo();
            });
        }
        
        function addCalcData() {
            const calcData = {
                type: 'unemployment',
                data: '40ì„¸/180ì¼/63,104ì›',
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('calcData', JSON.stringify(calcData));
            alert('ê³„ì‚° ë°ì´í„° ì¶”ê°€ ì™„ë£Œ!');
            updateDebugInfo();
        }
        
        function changeFingerprint() {
            isDevMode = false;
            const newFp = 'USER_' + Math.random().toString(36).substr(2, 9);
            alert('ìƒˆ ì§€ë¬¸ìœ¼ë¡œ ë³€ê²½ë¨. ì¼ë°˜ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.');
            updateDebugInfo();
            location.reload();
        }
        
        function clearAllData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                sessionStorage.clear();
                localStorage.clear();
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                alert('ì´ˆê¸°í™” ì™„ë£Œ!');
                location.reload();
            }
        }
        
        function clearCookies() {
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            alert('ì¿ í‚¤ ì´ˆê¸°í™” ì™„ë£Œ!');
            updateDebugInfo();
        }
        
        function toggleMode() {
            isDevMode = !isDevMode;
            document.getElementById('modeIndicator').textContent = isDevMode ? 'ê°œë°œ ëª¨ë“œ' : 'ì¼ë°˜ ëª¨ë“œ';
            document.getElementById('modeIndicator').className = isDevMode ? 'mode-indicator mode-dev' : 'mode-indicator mode-prod';
            updateDebugInfo();
        }
        
        function showStorageInfo() {
            const info = {
                sessionStorage: Object.keys(sessionStorage),
                localStorage: Object.keys(localStorage),
                cookies: document.cookie
            };
            alert('Storage ì •ë³´:\n' + JSON.stringify(info, null, 2));
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateDebugInfo() {
            const fp = getFingerprint();
            const cookie = checkCookie();
            document.getElementById('fpDisplay').textContent = fp.substring(0, 20) + '...';
            document.getElementById('calcStatus').textContent = sessionStorage.getItem('calc_used_' + fp) ? 'âœ…' : 'âŒ';
            document.getElementById('calcDataStatus').textContent = getCalculatorData() ? 'ìˆìŒ' : 'ì—†ìŒ';
            document.getElementById('cookieStatus').textContent = cookie ? cookie.substring(0, 10) + '...' : 'ì—†ìŒ';
            document.getElementById('currentMode').textContent = isDevMode ? 'ê°œë°œ ëª¨ë“œ' : 'ì¼ë°˜ ëª¨ë“œ';
            document.getElementById('usageCount').textContent = currentUsageCount;
        }
        
        // ê¸€ììˆ˜ ì¹´ìš´í„°
        questionInput.addEventListener('input', function() {
            const length = this.value.length;
            charCountSpan.textContent = `${length}/150`;
            
            if (length >= 150) {
                charCountSpan.className = 'char-count error';
            } else if (length >= 130) {
                charCountSpan.className = 'char-count warning';
            } else {
                charCountSpan.className = 'char-count';
            }
        });
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // êµ¬ì¡°í™”ëœ ë‹µë³€ í¬ë§·íŒ…
        function formatStructuredResponse(text) {
            // ã€ê²°ê³¼ã€‘ ã€ê·¼ê±°ã€‘ ã€ì„¸ë¶€ì‚¬í•­ã€‘ ã€í•„ìš”ì„œë¥˜ã€‘ ë“±ì„ ìŠ¤íƒ€ì¼ë§
            let formatted = text;
            formatted = formatted.replace(/ã€ê²°ê³¼ã€‘/g, '<div class="result-box"><strong>ã€ê²°ê³¼ã€‘</strong>');
            formatted = formatted.replace(/ã€ê·¼ê±°ã€‘/g, '</div><div class="basis-box"><strong>ã€ê·¼ê±°ã€‘</strong>');
            formatted = formatted.replace(/ã€ì„¸ë¶€ì‚¬í•­ã€‘/g, '</div><div class="detail-box"><strong>ã€ì„¸ë¶€ì‚¬í•­ã€‘</strong>');
            formatted = formatted.replace(/ã€í•„ìš”ì„œë¥˜ã€‘/g, '</div><div class="docs-box"><strong>ã€í•„ìš”ì„œë¥˜ã€‘</strong>');
            formatted = formatted.replace(/ã€ì£¼ìš” ê·¼ê±°ã€‘/g, '</div><div class="basis-box"><strong>ã€ì£¼ìš” ê·¼ê±°ã€‘</strong>');
            formatted = formatted.replace(/ã€ìƒí™© ë¶„ì„ã€‘/g, '</div><div class="detail-box"><strong>ã€ìƒí™© ë¶„ì„ã€‘</strong>');
            formatted = formatted.replace(/ã€ê³„ì‚°ã€‘/g, '</div><div class="detail-box"><strong>ã€ê³„ì‚°ã€‘</strong>');
            formatted = formatted.replace(/ã€ì¶œì²˜ã€‘/g, '</div><div class="basis-box"><strong>ã€ì¶œì²˜ã€‘</strong>');
            
            // ë§ˆì§€ë§‰ div ë‹«ê¸°
            if (formatted.includes('<div class="')) {
                formatted += '</div>';
            }
            
            // ì²« ë²ˆì§¸ div ì• í…ìŠ¤íŠ¸ ì²˜ë¦¬
            if (!formatted.startsWith('<div class="')) {
                const firstDivIndex = formatted.indexOf('<div class="');
                if (firstDivIndex > 0) {
                    formatted = formatted.substring(firstDivIndex);
                }
            }
            
            return formatted;
        }
        
        async function sendQuestion() {
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (question.length > 150) {
                alert('ì§ˆë¬¸ì€ 150ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            sendBtn.disabled = true;
            responseDiv.innerHTML = '<div class="loading">Qwen3 ëª¨ë¸ì´ ë‹µë³€ì„ ìƒì„±ì¤‘...</div>';
            
            try {
                const fingerprint = getFingerprint();
                const calcData = getCalculatorData();
                
                const response = await fetch('http://localhost:5000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        fingerprint: fingerprint,
                        calcData: calcData
                    }),
                    credentials: 'include'  // ì¿ í‚¤ í¬í•¨
                });
                
                const data = await response.json();
                
                let html = '';
                
                if (data.error) {
                    html = `<div class="error">${escapeHtml(data.error)}</div>`;
                    
                    if (data.redirect) {
                        setTimeout(() => {
                            if (confirm('ê³„ì‚°ê¸° í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                window.location.href = data.redirect;
                            }
                        }, 1000);
                    }
                } else {
                    // êµ¬ì¡°í™”ëœ ë‹µë³€ í¬ë§·íŒ… ì ìš©
                    const formattedAnswer = formatStructuredResponse(data.answer);
                    html = `<div>${formattedAnswer}</div>`;
                    
                    // ì¶œì²˜ í‘œì‹œ (Qwen3ëŠ” ë³´í†µ ì¶œì²˜ê°€ ì—†ìŒ)
                    if (data.sources && data.sources.length > 0) {
                        html += '<div class="sources"><strong>ì°¸ê³  ìë£Œ:</strong>';
                        data.sources.forEach(source => {
                            if (source.url) {
                                html += `<a href="${escapeHtml(source.url)}" target="_blank" class="source-link">ğŸ” ${escapeHtml(source.title || source.url)}</a>`;
                            }
                        });
                        html += '</div>';
                    }
                }
                
                // ë‚¨ì€ íšŸìˆ˜ ì—…ë°ì´íŠ¸
                if (data.remaining !== undefined) {
                    remainingCountSpan.textContent = `ì˜¤ëŠ˜ ë‚¨ì€ ì§ˆë¬¸: ${data.remaining}íšŒ`;
                    currentUsageCount = 3 - data.remaining;
                    
                    if (data.remaining === 0) {
                        sendBtn.disabled = true;
                        sendBtn.textContent = 'ë‚´ì¼ ë‹¤ì‹œ ì´ìš© ê°€ëŠ¥';
                    }
                }
                
                responseDiv.innerHTML = html;
                updateDebugInfo();
                
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">ì˜¤ë¥˜ ë°œìƒ: ${escapeHtml(error.message)}</div>`;
            } finally {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                if (!sendBtn.textContent.includes('ë‚´ì¼')) {
                    sendBtn.disabled = false;
                }
            }
        }
        
        // ì—”í„°í‚¤ë¡œ ì „ì†¡
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendQuestion();
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            updateDebugInfo();
            console.log('Qwen3-235B-A22B-Instruct-2507 ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ');
        };
    </script>
</body>
</html>